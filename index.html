<!DOCTYPE html>
<html>
  <head>
    <title></title>
    <link
      href="https://fonts.googleapis.com/css?family=Inter"
      rel="stylesheet"
    />
  </head>
  <body style="background-color: #eeeeee">
    <style>
      body {
        font-family: "Inter";
        text-align: center;
      }
      input {
        height: 2em;
        width: 20em;
        vertical-align: middle;
      }
      label {
        color: black;
      }
      .container {
        width: 95%;
        background-color: #eeeeee;
        font-size: 12px;
        text-align: left;
      }
      .input {
        margin: 5px 0px;
        padding: 1px 10px;
        border: 1px solid #eeeeee;
        border-radius: 5px;
        outline: 0;
        height: 25px;
        width: 100%;
        font-size: 12px;
      }
      .custom-select {
        margin: 5px 0px;
        padding: 5px 10px;
        border-radius: 5px;
        border: 1px solid #eeeeee;
        height: 30px;
        width: 100%;
        font-size: 12px;
        font-family: "Inter";
      }
      .input:focus {
        border: 1px solid #dd0150;
      }
      .custom-select:focus {
        border: 1px solid #dd0150;
      }
      .submit {
        background-color: #dd0150;
        padding: 15px;
        width: 100%;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        border: none;
        color: white;
        height: 45px;
        margin-top: 4rem;
      }
      .submit:hover {
        background-color: #f74586;
      }
      .result {
        font-weight: bold;
        margin: 10px 0px 20px;
      }
      .checkbox-group {
        margin: 5px 0px;
        padding: 10px;
        border: 1px solid #eeeeee;
        border-radius: 5px;
        background-color: white;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-width: 100%;
      }
      .checkbox-item {
        margin: 8px 0;
        display: flex;
        align-items: center;
      }
      .checkbox-item input[type="checkbox"] {
        width: auto;
        height: auto;
        margin-right: 8px;
      }
      .checkbox-item label {
        margin: 0;
        cursor: pointer;
        flex: 1;
      }
    </style>

    <center>
      <div class="container">
        <label id="header"></label> <br /><br />
        <form>
          <!-- Order Number -->
          <label id="lOrderNumber"></label><br />
          <input
            class="input"
            id="orderNumber"
            type="text"
            value=""
            name="orderNumber"
            required
            readonly
          />
          <div id="rOrderNumber" class="result"></div>

          <!-- ✅ Email Field -->
          <label id="lemail"></label><br />
          <input
            class="input"
            id="email"
            type="email"
            name="email"
            required
          />
          <div id="remail" class="result"></div>

          <!-- Issue -->
          <label id="lIssue"></label><br />
          <input
            class="input"
            id="issue"
            type="text"
            value=""
            name="issue"
            required
            readonly
          />
          <div id="rIssue" class="result"></div>

          <!-- Items -->
          <label id="lChooseItem"></label><br />
          <div class="checkbox-group" id="itemCheckboxGroup"></div>
          <div id="rItems" class="result"></div>

          <!-- Date Picker -->
          <label id="lDate"></label><br />
          <input
            class="input"
            id="datePicker"
            type="date"
            name="datePicker"
            required
          />
          <div id="rDate" class="result"></div>

          <!-- Description -->
          <label id="lDescription"></label><br />
          <input
            class="input"
            id="description"
            type="text"
            name="description"
            required
          />
          <div id="rDescription" class="result"></div>

          <input type="hidden" id="language" name="language" value="en" required/>
          <button id="submit" class="submit" type="submit"></button>
        </form>
      </div>
    </center>

    <script type="text/javascript">
      let params = new URLSearchParams(window.location.search);
      var language = params.get("language");
      var orderNumber = params.get("orderNumber");
      var issue = params.get("issue");
      var items = params.get("items");
      var email = params.get("email");
      var description = params.get("description");
      var date = params.get("date");

      document.getElementById("orderNumber").setAttribute("value", orderNumber || "");
      document.getElementById("issue").setAttribute("value", issue || "");
      if (email) document.getElementById("email").setAttribute("value", email);
      if (date) document.getElementById("datePicker").setAttribute("value", date);

      // ✅ Dynamic checkbox creation
      function createCheckboxes(values) {
        const container = document.getElementById("itemCheckboxGroup");
        container.innerHTML = "";
        values.forEach((value, index) => {
          const div = document.createElement("div");
          div.classList.add("checkbox-item");

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = "item" + index;
          checkbox.name = "items";
          checkbox.value = value;

          const label = document.createElement("label");
          label.setAttribute("for", "item" + index);
          label.textContent = value;

          div.appendChild(checkbox);
          div.appendChild(label);
          container.appendChild(div);
        });
      }

      const selectedFromUrl = params.get("selected")
        ? params.get("selected").split(",")
        : [];
      createCheckboxes(selectedFromUrl);

      // ✅ Populate view mode if already submitted
      if (orderNumber && issue && items && description && date && email) {
        showSummary({ orderNumber, issue, items: items.split(","), description, date, email });
      }

      // ✅ Language setup
      if (language == "id") {
        document.getElementById("header").innerHTML =
          "Lengkapi informasi berikut untuk melaporkan masalah.";
        document.getElementById("lOrderNumber").innerHTML = "Nomor Pesanan:";
        document.getElementById("lemail").innerHTML = "Email Aktif:";
        document.getElementById("email").setAttribute("placeholder", "Email Aktif");

        document.getElementById("lIssue").innerHTML = "Masalah:";
        document.getElementById("lChooseItem").innerHTML =
          "Pilih barang yang belum diterima:";
        document.getElementById("lDate").innerHTML ="Pilih Tanggal Kedaluwarsa (Cek kemasan produk, ya)";
        document.getElementById("lDescription").innerHTML = "Jelaskan Masalah:";
        document.getElementById("description").setAttribute("placeholder","Jelaskan Masalah");
        document.getElementById("submit").innerHTML = "Kirim";
      } else {
        document.getElementById("header").innerHTML =
          "Please share the following information to report an issue.";
        document.getElementById("lOrderNumber").innerHTML = "Order Number:";
        document.getElementById("email").setAttribute("placeholder", "Active Email ID");
        document.getElementById("lemail").innerHTML = "Active Email ID:";
        document.getElementById("lIssue").innerHTML = "Issue:";
        document.getElementById("lChooseItem").innerHTML =
          "Choose items not yet received:";
        document.getElementById("lDate").innerHTML = "Select the expiry date (Check the product packaging)";
        document.getElementById("lDescription").innerHTML =
          "Tell us what’s going on:";
          document.getElementById("description").setAttribute("placeholder", "Tell us what’s going on");
        document.getElementById("submit").innerHTML = "Submit";
      }

      // ✅ Form submission
      document.querySelector("form").addEventListener("submit", function (e) {
        e.preventDefault();

        const orderNum = document.getElementById("orderNumber").value;
        const selectedIssue = document.getElementById("issue").value;
        const emailValue = document.getElementById("email").value.trim();
        const checkboxes = document.querySelectorAll('input[name="items"]:checked');
        const selectedItems = Array.from(checkboxes).map((cb) => cb.value);
        const selectedDate = document.getElementById("datePicker").value;
        const problemDescription = document.getElementById("description").value.trim();

        if (!emailValue) {
          alert("Please enter a valid email");
          return;
        }
        if (selectedItems.length === 0) {
          alert("Please select at least one item");
          return;
        }
        if (!selectedDate) {
          alert("Please select a date");
          return;
        }

        const urlParams = new URLSearchParams();
        urlParams.set("orderNumber", orderNum);
        urlParams.set("issue", selectedIssue);
        urlParams.set("email", emailValue);
        urlParams.set("items", selectedItems.join(","));
        urlParams.set("description", problemDescription);
        urlParams.set("date", selectedDate);
        urlParams.set("language", language);

        const newUrl = window.location.pathname + "?" + urlParams.toString();
        window.history.pushState({}, "", newUrl);

        const sendData = {
          orderNumber: orderNum,
          issue: selectedIssue,
          email: emailValue,
          items: selectedItems,
          description: problemDescription,
          date: selectedDate,
        };
        showSummary(sendData);
      });

      function showSummary(sendData) {
        console.log(sendData);
        let data = JSON.stringify(sendData);
        // Hide form
        document.getElementById("orderNumber").setAttribute("type", "hidden");
        document.getElementById("email").hidden = true;
        document.getElementById("issue").hidden = true;
        document.getElementById("itemCheckboxGroup").hidden = true;
        document.getElementById("datePicker").hidden = true;
        document.getElementById("description").hidden = true;
        document.getElementById("submit").style.visibility = "hidden";

        // Show results
        document.getElementById("rOrderNumber").innerHTML = sendData.orderNumber;
        document.getElementById("remail").innerHTML = sendData.email;
        document.getElementById("rIssue").innerHTML = sendData.issue;
        document.getElementById("rItems").innerHTML = sendData.items.join(", ");
        document.getElementById("rDate").innerHTML = sendData.date;
        document.getElementById("rDescription").innerHTML = sendData.description;

        window.parent.postMessage(
          JSON.stringify({
            event_code: "ym-client-event",
            data: JSON.stringify({
              event: { code: new Date().getTime().toString(), data },
            }),
          }),
          "*"
        );
        console.log(
          JSON.stringify({
            event_code: "ym-client-event",
            data: JSON.stringify({
              event: {
                code: new Date().getTime().toString(),
                data,
              },
            }),
          })
        );
      }
    </script>
  </body>
</html>
